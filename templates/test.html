{% extends '_base.html' %}

{% block head %}
<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" type="text/css" />
{% endblock head %}

 {% block content %}
 <form action="."  style="margin-bottom: 5px;" enctype="multipart/form-data" method="POST" class="dropzone grid-x grid-margin-x cell large-12" id="dropzone">
 {% csrf_token %}
     <input type="hidden" name="producto" value="{{property.id}}">
 </form>

 {% if property_images %}
  {% for property_image in property_images %}
    <input type="hidden" name="" value="{{ property_image.image }}" class="galeria">
  {% endfor %}
 {% endif %}

{% endblock content %} 


{% block js %}

<script>
 Dropzone.autoDiscover = false;

document.addEventListener('DOMContentLoaded', () => {
    const dropzone = new Dropzone('form#dropzone', {
        dictDefaultMessage: 'Sube hasta 10 imÃ¡genes',
        acceptedFiles: ".png,.jpg,.gif,.jpeg",
        addRemoveLinks: true,
        dictRemoveFile: "Eliminar Imagen",
        maxFiles: 10,
        autoProcessQueue: false,

        init: function(){
          const galeria = document.querySelectorAll('.galeria');
           const dominio ='http://localhost:8000'
            if(galeria.length > 0 ) {
                galeria.forEach(imagen => {
                    const imagenPublicada = {};
                    imagenPublicada.size = 1;
                    imagenPublicada.name = imagen.value;
                    imagenPublicada.nombreServidor = imagen.value;

                    this.options.addedfile.call(this, imagenPublicada);
                    this.options.thumbnail.call(this, imagenPublicada, `${dominio}/media/${imagenPublicada.name}`);
  
                    imagenPublicada.previewElement.classList.add('dz-success');
                    imagenPublicada.previewElement.classList.add('dz-complete');
                    

                })
            }
        }
    })
    
    dropzone.on('success', function(file, respuesta){
       
        file.nombreServidor = respuesta.data.archivo;
    })

    dropzone.on('removedfile', function(file){
        const params = {
            imagen: file.nombreServidor,
            action: 'delete'
        }
      
        // const  url=  document.querySelector("#url").value;
        const  url=  location.href;
      
        fetch(url, {
            method: "POST",
            body: JSON.stringify(params),
            headers: {
            "Content-type": "application/json;charset=UTF-8",
            'X-CSRFToken': csrftoken
          }
            
        }).then(function (res){
          if (res.status == 200) {
            return res.json()
          }else{
            throw new Error();
          }
        }).then(data=>{
          console.log(data);
        }) 
        .catch(err => console.log(err));



    })

})
</script>
{% endblock js %}

<!-- const params = {
  imagen: file.nombreServidor,
  action: 'delete'
}

// const  url=  document.querySelector("#url").value;
const  url=  location.href; -->